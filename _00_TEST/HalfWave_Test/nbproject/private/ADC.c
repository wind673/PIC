/**********************************************************************************************
 *   文 件 名：ADC.c
 *
 *   调试平台：PIC18FXX 开发平台
 *
 *   作    者：唐 江
 *
 *   日    期：2013.9.4
 **********************************************************************************************/
 
/* 包含 --------------------------------------------------------------------------------------*/
#include "ADC.h"
/* 私有宏 ------------------------------------------------------------------------------------*/

/* 私有变量 ----------------------------------------------------------------------------------*/
extern __Parameter Parameter[PARAM_NUM+1];
/* 私有结构体 --------------------------------------------------------------------------------*/

/* 私有函数声明 ------------------------------------------------------------------------------*/

/* 私有函数模型 ------------------------------------------------------------------------------*/

/**********************************************************************************************
 *名    称：void ADC_Init(void)
 *
 *参    数：无
 *
 *返 回 值：无
 *
 *描    述：ADC初始化
 *********************************************************************************************/
void ADC_Init(void)
{
    uint32_t elec = 0,i;
    OpenADC(ADC_RIGHT_JUST &
            ADC_4_TAD &
            ADC_FOSC_2,
            
            ADC_CH6,
            
            ADC_TRIG_CCP2 &
            ADC_REF_VDD_INT_VREF_4 &
            ADC_REF_VDD_VSS &          //负参考电压选择
            ADC_NEG_CH0                //模拟负通道选择位（一般选择通道0--AVss）
            );
    ADC_INT_DISABLE();                 //关ADC中断
	for(i = 0;i < 5;i++)
	{
		ConvertADC();
        while(BusyADC());
		elec += ReadADC();
	}
	Parameter[_ELEC_SETOVER].Value = elec/5;
}

/**********************************************************************************************
 *名    称：uint16_t ADC_ElecGet(void)
 *
 *参    数：无
 *
 *返 回 值：uint16_t elec   电流采样值
 *
 *描    述：电流采样
 *********************************************************************************************/
uint16_t ADC_ElecGet(void)
{
	uint32_t elec = 0,i;
	for(i = 0;i < 5;i++)
	{
		ConvertADC();
        while(BusyADC());
		elec += ReadADC();
	}
	elec = elec/5;
	if(elec > Parameter[_ELEC_SETOVER].Value)
		elec = (elec-Parameter[_ELEC_SETOVER].Value)/Parameter[_ELEC_COEFF].Value;
	else
		elec = (Parameter[_ELEC_SETOVER].Value - elec)/Parameter[_ELEC_COEFF].Value;
	return elec;
}
/* 文件结束 ---------------------------------------------------------------------------------*/




